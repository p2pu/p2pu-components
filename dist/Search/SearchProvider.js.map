{"version":3,"file":"SearchProvider.js","names":["React","Component","t","queryString","SEARCH_PROPS","API_ENDPOINTS","OPEN_TAB_TEXT","CLOSED_TAB_TEXT","ApiHelper","SearchProvider","props","defaults","searchResults","totalResults","distance","useMiles","limit","offset","isLoading","hasMoreResults","appendResults","order","searchSubject","parsedParams","parse","window","location","search","arrayFormat","arrayItems","forEach","term","resultsTab","signup","online","initialState","params","searchParams","privateParams","allowedParams","Object","keys","state","filter","key","includes","reduce","obj","query","stringify","skipNull","skipEmptyString","history","replaceState","document","title","pathname","tabIndex","setState","updateQueryParams","setInitialState","handleChange","s","_handleChange","handleInputChange","_handleInputChange","handleSearchBarSubmit","_handleSearchBarSubmit","searchCallback","response","opts","_searchCallback","_updateQueryParams","sendQuery","_sendQuery","loadInitialData","_loadInitialData","apiHelper","origin","scrollContainer","scrollContainerEl","querySelector","body","getScrollTop","scrollTop","pageYOffset","documentElement","onscroll","scrollHeight","clientHeight","innerHeight","scrolledToBottom","Math","ceil","length","prevProps","prevState","city","updateResultsTab","initialQuery","options","callback","fetchResource","updateURL","selected","label","searchByLocation","value","clearResults","results","concat","items","currentQuery","count","signupOpenCount","signup_open_count","signupClosedCount","signup_closed_count","showNoResultsComponent","Boolean","Children","map","children","child","cloneElement"],"sources":["../../src/Search/SearchProvider.jsx"],"sourcesContent":["import React, { Component } from 'react'\nimport { t } from 'ttag';\nimport queryString from 'query-string';\n\nimport { SEARCH_PROPS, API_ENDPOINTS, OPEN_TAB_TEXT, CLOSED_TAB_TEXT } from '../utils/constants'\nimport ApiHelper from '../utils/apiHelper'\n\n\nexport default class SearchProvider extends Component {\n  constructor(props) {\n    super(props)\n    this.initialState = this.setInitialState()\n    this.state = this.initialState;\n    this.handleChange = (s) => this._handleChange(s);\n    this.handleInputChange = () => this._handleInputChange();\n    this.handleSearchBarSubmit = (query) => this._handleSearchBarSubmit(query);\n    this.searchCallback = (response, opts) => this._searchCallback(response, opts);\n    this.updateQueryParams = (params) => this._updateQueryParams(params);\n    this.sendQuery = (opts) => this._sendQuery(opts);\n    this.loadInitialData = () => this._loadInitialData();\n    this.apiHelper = new ApiHelper(this.props.searchSubject, this.props.origin);\n  }\n\n  setInitialState = () => {\n    let defaults = {\n      searchResults: [],\n      totalResults: 0,\n      distance: 16, // this is in km, use miles below indicates UI display\n      useMiles: true,\n      limit: 21,\n      offset: 0,\n      isLoading: false,\n      hasMoreResults: false,\n      appendResults: false,\n      order: this.props.searchSubject === 'learningCircles' ? 'first_meeting_date' : null\n    }\n\n    let parsedParams = queryString.parse(window.location.search, { arrayFormat: 'comma' });\n    const arrayItems = API_ENDPOINTS[this.props.searchSubject].arrayItems;\n\n    arrayItems.forEach(term => {\n      if (parsedParams[term] && typeof(parsedParams[term]) === \"string\") {\n        parsedParams[term] = [parsedParams[term]]\n      }\n    })\n\n    let resultsTab;\n\n    if (this.props.searchSubject === 'learningCircles') {\n      defaults.signup = 'open'\n      defaults.resultsTab = parsedParams.signup && parsedParams.signup == 'closed' ? 1 : 0\n      defaults.online = null\n    }\n\n    return {\n      ...defaults,\n      ...this.props.initialState,\n      ...parsedParams\n    }\n  }\n\n  componentDidMount() {\n    const { scrollContainer } = this.props;\n    const scrollContainerEl = scrollContainer ? document.querySelector(scrollContainer) : document.body\n\n    const getScrollTop = scrollContainer ? () => { return scrollContainerEl.scrollTop } : () => { return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop }\n\n    scrollContainerEl.onscroll = () => {\n      const { isLoading, hasMoreResults } = this.state;\n      if (isLoading || !hasMoreResults) {\n        return;\n      }\n\n      const scrollTop = getScrollTop()\n      const scrollHeight = (document.querySelector(\".search-results\") && document.querySelector(\".search-results\").scrollHeight) || document.body.scrollHeight;\n      const clientHeight = window.innerHeight;\n      const scrolledToBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight;\n\n      if (scrolledToBottom && !this.state.isLoading) {\n        this.updateQueryParams({ offset: this.state.searchResults.length, appendResults: true })\n      }\n    };\n\n    this.loadInitialData();\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (prevState.city !== this.state.city) {\n      this.updateResultsTab(0)\n    }\n  }\n\n  _loadInitialData() {\n    this.sendQuery({ initialQuery: true });\n  }\n\n  _sendQuery(opts={}) {\n    const params = this.state;\n    const options = { params, callback: this.searchCallback, ...opts };\n\n    this.apiHelper.fetchResource(options);\n  }\n\n  _updateQueryParams(params) {\n    this.setState({ ...params, isLoading: true }, () => {\n      this.sendQuery()\n      this.updateURL()\n    })\n  }\n\n  updateURL = params => {\n    const searchParams = API_ENDPOINTS[this.props.searchSubject].searchParams;\n    const privateParams = API_ENDPOINTS[this.props.searchSubject].privateParams;\n    const allowedParams = Object.keys(this.state)\n      .filter(key => (searchParams.includes(key) && !privateParams.includes(key)))\n      .reduce((obj, key) => {\n        return {\n          ...obj,\n          [key]: this.state[key]\n        };\n      }, {});\n\n    const query = queryString.stringify(allowedParams, { skipNull: true, skipEmptyString: true, arrayFormat: 'comma' })\n    window.history.replaceState(allowedParams, document.title, `${window.location.pathname}?${query}`)\n  }\n\n  _handleChange(selected) {\n    const query = selected ? selected.label : selected;\n    this.props.searchByLocation(query);\n    this.setState({ value: selected });\n  }\n\n  _handleInputChange() {\n    this.props.clearResults();\n  }\n\n  _searchCallback(response, opts) {\n    const results = this.state.appendResults ? this.state.searchResults.concat(response.items) : response.items;\n\n    this.setState({\n      searchResults: results,\n      currentQuery: opts.params,\n      totalResults: response.count,\n      offset: 0,\n      isLoading: false,\n      appendResults: false,\n      hasMoreResults: response.count > 0 && results.length < response.count,\n      initialQuery: opts.initialQuery,\n      signupOpenCount: response.signup_open_count,\n      signupClosedCount: response.signup_closed_count,\n    })\n  }\n\n  updateResultsTab = (tabIndex) => {\n    this.setState({ searchResults: [] })\n    this.updateQueryParams({\n      resultsTab: tabIndex,\n      signup: tabIndex === 0 ? 'open' : 'closed',\n      order: tabIndex === 0 ? 'first_meeting_date' : 'last_meeting_date',\n    })\n  }\n\n  render() {\n    const showNoResultsComponent = this.state.totalResults === 0 && this.state.initialQuery && !Boolean(window.location.search);\n\n    return(\n      <>\n        { \n          React.Children.map(this.props.children, child =>\n            React.cloneElement(child, {\n              updateQueryParams: this.updateQueryParams,\n              searchSubject: this.props.searchSubject,\n              order: this.props.order,\n              results: this.state.searchResults,\n              updateResultsTab: this.updateResultsTab,\n              showNoResultsComponent: true,\n              ...this.state,\n              ...this.props\n            })\n        )}\n      </>\n    )\n  }\n}\n"],"mappings":"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"}