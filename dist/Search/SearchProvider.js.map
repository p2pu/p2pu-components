{"version":3,"sources":["../../src/Search/SearchProvider.jsx"],"names":["React","Component","t","queryString","SEARCH_PROPS","API_ENDPOINTS","OPEN_TAB_TEXT","CLOSED_TAB_TEXT","ApiHelper","SearchProvider","props","defaults","searchResults","totalResults","distance","useMiles","limit","offset","isLoading","hasMoreResults","appendResults","order","searchSubject","parsedParams","parse","window","location","search","arrayFormat","arrayItems","forEach","term","resultsTab","signup","initialState","params","searchParams","privateParams","allowedParams","Object","keys","state","filter","key","includes","reduce","obj","query","stringify","skipNull","skipEmptyString","history","replaceState","document","title","pathname","tabIndex","setState","updateQueryParams","setInitialState","handleChange","s","_handleChange","handleInputChange","_handleInputChange","handleSearchBarSubmit","_handleSearchBarSubmit","searchCallback","response","opts","_searchCallback","_updateQueryParams","sendQuery","_sendQuery","loadInitialData","_loadInitialData","apiHelper","origin","scrollContainer","scrollContainerEl","querySelector","body","getScrollTop","scrollTop","pageYOffset","documentElement","onscroll","scrollHeight","clientHeight","innerHeight","scrolledToBottom","Math","ceil","length","prevProps","prevState","city","updateResultsTab","initialQuery","options","callback","fetchResource","updateURL","selected","label","searchByLocation","value","clearResults","results","concat","items","currentQuery","count","signupOpenCount","signup_open_count","signupClosedCount","signup_closed_count","showNoResultsComponent","Boolean","Children","map","children","child","cloneElement"],"mappings":"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","sourcesContent":["import React, { Component } from 'react'\nimport { t } from 'ttag';\nimport queryString from 'query-string';\n\nimport { SEARCH_PROPS, API_ENDPOINTS, OPEN_TAB_TEXT, CLOSED_TAB_TEXT } from '../utils/constants'\nimport ApiHelper from '../utils/apiHelper'\n\n\nexport default class SearchProvider extends Component {\n  constructor(props) {\n    super(props)\n    this.initialState = this.setInitialState()\n    this.state = this.initialState;\n    this.handleChange = (s) => this._handleChange(s);\n    this.handleInputChange = () => this._handleInputChange();\n    this.handleSearchBarSubmit = (query) => this._handleSearchBarSubmit(query);\n    this.searchCallback = (response, opts) => this._searchCallback(response, opts);\n    this.updateQueryParams = (params) => this._updateQueryParams(params);\n    this.sendQuery = (opts) => this._sendQuery(opts);\n    this.loadInitialData = () => this._loadInitialData();\n    this.apiHelper = new ApiHelper(this.props.searchSubject, this.props.origin);\n  }\n\n  setInitialState = () => {\n    let defaults = {\n      searchResults: [],\n      totalResults: 0,\n      distance: 16, // this is in km, use miles below indicates UI display\n      useMiles: true,\n      limit: 21,\n      offset: 0,\n      isLoading: false,\n      hasMoreResults: false,\n      appendResults: false,\n      order: this.props.searchSubject === 'learningCircles' ? 'first_meeting_date' : null\n    }\n\n    let parsedParams = queryString.parse(window.location.search, { arrayFormat: 'comma' });\n    const arrayItems = API_ENDPOINTS[this.props.searchSubject].arrayItems;\n\n    arrayItems.forEach(term => {\n      if (parsedParams[term] && typeof(parsedParams[term]) === \"string\") {\n        parsedParams[term] = [parsedParams[term]]\n      }\n    })\n\n    let resultsTab;\n\n    if (this.props.searchSubject === 'learningCircles') {\n      defaults.signup = 'open'\n      defaults.resultsTab = parsedParams.signup && parsedParams.signup == 'closed' ? 1 : 0\n    }\n\n    return {\n      ...defaults,\n      ...this.props.initialState,\n      ...parsedParams\n    }\n  }\n\n  componentDidMount() {\n    const { scrollContainer } = this.props;\n    const scrollContainerEl = scrollContainer ? document.querySelector(scrollContainer) : document.body\n\n    const getScrollTop = scrollContainer ? () => { return scrollContainerEl.scrollTop } : () => { return window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop }\n\n    scrollContainerEl.onscroll = () => {\n      const { isLoading, hasMoreResults } = this.state;\n      if (isLoading || !hasMoreResults) {\n        return;\n      }\n\n      const scrollTop = getScrollTop()\n      const scrollHeight = (document.querySelector(\".search-results\") && document.querySelector(\".search-results\").scrollHeight) || document.body.scrollHeight;\n      const clientHeight = window.innerHeight;\n      const scrolledToBottom = Math.ceil(scrollTop + clientHeight) >= scrollHeight;\n\n      if (scrolledToBottom && !this.state.isLoading) {\n        this.updateQueryParams({ offset: this.state.searchResults.length, appendResults: true })\n      }\n    };\n\n    this.loadInitialData();\n  }\n\n  componentDidUpdate(prevProps, prevState) {\n    if (prevState.city !== this.state.city) {\n      this.updateResultsTab(0)\n    }\n  }\n\n  _loadInitialData() {\n    this.sendQuery({ initialQuery: true });\n  }\n\n  _sendQuery(opts={}) {\n    const params = this.state;\n    const options = { params, callback: this.searchCallback, ...opts };\n\n    this.apiHelper.fetchResource(options);\n  }\n\n  _updateQueryParams(params) {\n    this.setState({ ...params, isLoading: true }, () => {\n      this.sendQuery()\n      this.updateURL()\n    })\n  }\n\n  updateURL = params => {\n    const searchParams = API_ENDPOINTS[this.props.searchSubject].searchParams;\n    const privateParams = API_ENDPOINTS[this.props.searchSubject].privateParams;\n    const allowedParams = Object.keys(this.state)\n      .filter(key => (searchParams.includes(key) && !privateParams.includes(key)))\n      .reduce((obj, key) => {\n        return {\n          ...obj,\n          [key]: this.state[key]\n        };\n      }, {});\n\n    const query = queryString.stringify(allowedParams, { skipNull: true, skipEmptyString: true, arrayFormat: 'comma' })\n    window.history.replaceState(allowedParams, document.title, `${window.location.pathname}?${query}`)\n  }\n\n  _handleChange(selected) {\n    const query = selected ? selected.label : selected;\n    this.props.searchByLocation(query);\n    this.setState({ value: selected });\n  }\n\n  _handleInputChange() {\n    this.props.clearResults();\n  }\n\n  _searchCallback(response, opts) {\n    const results = this.state.appendResults ? this.state.searchResults.concat(response.items) : response.items;\n\n    this.setState({\n      searchResults: results,\n      currentQuery: opts.params,\n      totalResults: response.count,\n      offset: 0,\n      isLoading: false,\n      appendResults: false,\n      hasMoreResults: response.count > 0 && results.length < response.count,\n      initialQuery: opts.initialQuery,\n      signupOpenCount: response.signup_open_count,\n      signupClosedCount: response.signup_closed_count,\n    })\n  }\n\n  updateResultsTab = (tabIndex) => {\n    this.setState({ searchResults: [] })\n    this.updateQueryParams({\n      resultsTab: tabIndex,\n      signup: tabIndex === 0 ? 'open' : 'closed',\n      order: tabIndex === 0 ? 'first_meeting_date' : 'last_meeting_date',\n    })\n  }\n\n  render() {\n    const showNoResultsComponent = this.state.totalResults === 0 && this.state.initialQuery && !Boolean(window.location.search);\n\n    return(\n      <>\n        { \n          React.Children.map(this.props.children, child =>\n            React.cloneElement(child, {\n              updateQueryParams: this.updateQueryParams,\n              searchSubject: this.props.searchSubject,\n              order: this.props.order,\n              results: this.state.searchResults,\n              updateResultsTab: this.updateResultsTab,\n              showNoResultsComponent: true,\n              ...this.state,\n              ...this.props\n            })\n        )}\n      </>\n    )\n  }\n}\n"],"file":"SearchProvider.js"}